<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COMCESA - Control de Asistencia</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/3.2.0/sha.js"></script>
<style>
:root {
--primary:#0B2A4A;--secondary:#1F4E79;--success:#2E7D32;
--danger:#C62828;--bg:#F4F6F8;--card:#fff;
--text:#1F2937;--muted:#6B7280;--border:#E5E7EB;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:"Segoe UI",Arial;background:var(--bg);padding:30px}
.container{max-width:480px;margin:40px auto;background:var(--card);
border-radius:6px;border:1px solid var(--border);padding:35px}
.container-wide{max-width:1200px}
.logo{text-align:center;margin-bottom:25px}
.logo img{height:55px}
h1{font-size:24px;color:var(--primary);text-align:center}
.subtitle{text-align:center;color:var(--muted);margin-bottom:25px;font-size:14px}
.input-group{margin-bottom:18px}
label{font-size:13px;font-weight:600;margin-bottom:6px;display:block}
input{width:100%;padding:11px;border:1px solid var(--border);border-radius:4px}
.btn{width:100%;padding:12px;font-weight:600;border:none;border-radius:4px;cursor:pointer}
.btn-primary{background:var(--primary);color:#fff}
.btn-secondary{background:#E5E7EB;margin-top:10px}
.btn-success{background:var(--success);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-small{width:auto;padding:8px 16px}
.hidden{display:none}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:15px}
.card{background:#F9FAFB;border:1px solid var(--border);padding:15px;border-radius:4px;margin-bottom:10px}
.badge{padding:4px 10px;font-size:11px;border-radius:20px;color:#fff}
.badge-entrada{background:var(--success)}
.badge-salida{background:var(--danger)}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:15px}
.stat-card{background:#fff;border:1px solid var(--border);padding:20px;border-radius:6px;text-align:center}
.stat-number{font-size:28px;font-weight:bold;color:var(--primary)}
table{width:100%;border-collapse:collapse}
th{background:var(--primary);color:#fff;padding:12px}
td{padding:12px;border-bottom:1px solid var(--border)}
.alert{padding:12px;border-radius:4px;margin-bottom:15px;font-size:14px}
.alert-info{background:#DBEAFE;color:#1E40AF;border:1px solid #93C5FD}
.alert-warning{background:#FEF3C7;color:#92400E;border:1px solid #FCD34D}
.qr-container{text-align:center;padding:20px;background:#fff;border:2px dashed var(--border);border-radius:8px;margin:20px 0}
#qrcode{display:inline-block;padding:15px;background:#fff}
.secret-key{background:#F3F4F6;padding:10px;border-radius:4px;font-family:monospace;font-size:14px;text-align:center;margin:10px 0;word-break:break-all}
.setup-steps{background:#F9FAFB;padding:15px;border-radius:4px;margin:15px 0}
.setup-steps ol{margin-left:20px}
.setup-steps li{margin:8px 0;font-size:14px}
@media(max-width:768px){.grid-2,.stats{grid-template-columns:1fr}}
</style>
</head>
<body>
<!-- LOGIN -->
<div id="loginScreen" class="container">
<div class="logo">
<img src="https://tse4.mm.bing.net/th/id/OIP.FWDv-1kVSpV5Dz_OMAu4IgHaBo?rs=1">
</div>
<h1>Control de Asistencia</h1>
<p class="subtitle">Ingresa tu usuario</p>
<div class="input-group">
<label>Usuario</label>
<input id="username">
</div>
<button class="btn btn-primary" onclick="checkUser()">Continuar</button>
<div class="alert alert-info" style="margin-top:15px">
</div>

<!-- CONFIGURACI√ìN INICIAL (PRIMERA VEZ) -->
<div id="setupScreen" class="container hidden">
<h1>Configuraci√≥n Inicial</h1>
<p class="subtitle">Hola, <span id="setupUserName"></span></p>
<div class="alert alert-warning">
‚ö†Ô∏è Es tu primera vez. Configura Google Authenticator
</div>
<div class="setup-steps">
<strong>Sigue estos pasos:</strong>
<ol>
<li>Descarga <strong>Google Authenticator</strong> en tu celular (Play Store o App Store)</li>
<li>Abre la app y toca el bot√≥n <strong>+</strong></li>
<li>Selecciona <strong>"Escanear c√≥digo QR"</strong></li>
<li>Escanea el c√≥digo QR de abajo</li>
</ol>
</div>
<div class="qr-container">
<div id="qrcode"></div>
<p style="margin-top:10px;color:var(--muted);font-size:13px">
O ingresa manualmente esta clave:
</p>
<div class="secret-key" id="secretKey"></div>
</div>
<div class="input-group">
<label>Ingresa el c√≥digo de 6 d√≠gitos que aparece en tu app</label>
<input id="setupCodeInput" placeholder="000000" maxlength="6" type="tel">
</div>
<button class="btn btn-primary" onclick="completeSetup()">Verificar y Continuar</button>
<button class="btn btn-secondary" onclick="logout()">Cancelar</button>
</div>

<!-- VERIFICACI√ìN -->
<div id="verificationScreen" class="container hidden">
<h1>Verificaci√≥n</h1>
<p class="subtitle">Hola, <span id="userName"></span></p>
<div class="alert alert-info">
üì± Abre <strong>Google Authenticator</strong> en tu celular
</div>
<div class="input-group">
<label>Ingresa el c√≥digo de 6 d√≠gitos de tu app</label>
<input id="codeInput" placeholder="000000" maxlength="6" type="tel">
</div>
<button class="btn btn-primary" onclick="verifyCode()">Verificar</button>
<button class="btn btn-secondary" onclick="logout()">Cancelar</button>
<div style="margin-top:15px;text-align:center;color:var(--muted);font-size:12px">
El c√≥digo cambia cada 30 segundos
</div>
</div>

<!-- EMPLEADO -->
<div id="employeeScreen" class="container hidden">
<h1>Bienvenido, <span id="employeeName"></span></h1>
<div class="grid-2">
<button class="btn btn-success" onclick="recordAttendance('entrada')">Registrar Entrada</button>
<button class="btn btn-danger" onclick="recordAttendance('salida')">Registrar Salida</button>
</div>
<h3 style="margin:20px 0">Mis registros de hoy</h3>
<div id="employeeRecords"></div>
<button class="btn btn-secondary" onclick="logout()">Cerrar sesi√≥n</button>
</div>

<!-- ADMIN -->
<div id="adminScreen" class="container container-wide hidden">
<h1>Panel Administrador</h1>
<div class="stats">
<div class="stat-card"><div class="stat-number" id="totalEmployees">0</div>Total Empleados</div>
<div class="stat-card"><div class="stat-number" id="totalRecords">0</div>Registros</div>
<div class="stat-card"><div class="stat-number" id="currentDate"></div>Fecha</div>
</div>

<!-- FILTROS DEL HISTORIAL -->
<div class="card" style="margin:20px 0">
<h3 style="margin-bottom:15px;color:var(--primary)">üîç Filtrar Historial</h3>
<div class="grid-2">
<div class="input-group" style="margin:0">
<label>Empleado</label>
<select id="filterUser" onchange="renderAdminRecords()" style="padding:11px;border:1px solid var(--border);border-radius:4px;width:100%">
<option value="">Todos los empleados</option>
</select>
</div>
<div class="input-group" style="margin:0">
<label>Fecha</label>
<input type="date" id="filterDate" onchange="renderAdminRecords()" style="padding:11px">
</div>
</div>
<div style="margin-top:15px;display:flex;gap:10px">
<button class="btn btn-secondary" onclick="filterToday()" style="width:auto;padding:8px 16px">üìÖ Hoy</button>
<button class="btn btn-secondary" onclick="filterYesterday()" style="width:auto;padding:8px 16px">‚èÆÔ∏è Ayer</button>
<button class="btn btn-secondary" onclick="clearFilters()" style="width:auto;padding:8px 16px">üîÑ Limpiar Filtros</button>
</div>
</div>

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h2 style="color:var(--primary)">Historial de Asistencias <span id="recordCount" style="font-size:16px;color:var(--muted)"></span></h2>
<div>
<button class="btn btn-primary" onclick="exportCSV()" style="margin:0;width:auto;padding:8px 16px">üì• Exportar CSV</button>
<button class="btn btn-danger" onclick="clearAllData()" style="margin:0 0 0 10px;width:auto;padding:8px 16px">üóëÔ∏è Borrar Todo</button>
</div>
</div>

<table>
<thead><tr><th>ID</th><th>Nombre</th><th>Tipo</th><th>Fecha y Hora</th></tr></thead>
<tbody id="recordsBody"></tbody>
</table>
<button class="btn btn-secondary" onclick="logout()" style="margin-top:20px">Cerrar sesi√≥n</button>
</div>

<script>
// ================= USUARIOS =================
const users = [
{ id:1, username:'josue.rodriguez', name:'Josue Rodriguez', role:'empleado', secret:null },
{ id:2, username:'yanira.lopez', name:'Yanira Lopez', role:'empleado', secret:null },
{ id:3, username:'luz.deleon', name:'Luz De Leon', role:'empleado', secret:null },
{ id:4, username:'rosa.gomez', name:'Rosa Gomez', role:'empleado', secret:null },
{ id:5, username:'benjamin.perez', name:'Benjamin Perez', role:'empleado', secret:null },
{ id:6, username:'dulce.guzman', name:'Dulce Guzman', role:'empleado', secret:null },
{ id:7, username:'roniel.chacon', name:'Roniel Chacon', role:'empleado', secret:null },
{ id:8, username:'william.palacios', name:'William Palacios', role:'empleado', secret:null },
{ id:9, username:'maria.rosales', name:'Maria Rosales', role:'empleado', secret:null },
{ id:10, username:'erick.garcia', name:'Erick Garcia', role:'empleado', secret:null },
{ id:11, username:'hever.rian', name:'Hever Rian', role:'empleado', secret:null },
{ id:12, username:'gabriela.vasquez', name:'Gabriela Vasquez', role:'empleado', secret:null },
{ id:13, username:'jorge.mendez', name:'Jorge Mendez', role:'empleado', secret:null },
{ id:14, username:'elias.ixcoy', name:'Elias Ixcoy', role:'empleado', secret:null },
{ id:15, username:'william.camey', name:'William Camey', role:'empleado', secret:null },
{ id:16, username:'rodolfo.xuya', name:'Rodolfo Xuya', role:'empleado', secret:null },
{ id:17, username:'bethzabe.delaroca', name:'Bethzabe de la Roca', role:'empleado', secret:null },
{ id:18, username:'teresa.aifan', name:'Teresa de Jesus Aifan', role:'empleado', secret:null },
{ id:19, username:'benigno.deleon', name:'Benigno De Leon Vasquez', role:'empleado', secret:null },
{ id:20, username:'juan.rodriguez', name:'Juan Jose Rodriguez', role:'empleado', secret:null },
{ id:21, username:'jose.avila', name:'Jose Avila', role:'empleado', secret:null },
{ id:22, username:'christian.valencia', name:'Christian Valencia', role:'empleado', secret:null },
{ id:23, username:'sergio.garcia', name:'Sergio Garcia', role:'empleado', secret:null },
{ id:99, username:'sys.ctrl_9XQ', name:'Administrador del Sistema', role:'admin', secret:null }
];

let records = [];
let currentUser = null;
let dataLoaded = false;

// ================= SISTEMA DE ALMACENAMIENTO PERMANENTE =================
async function loadData() {
if(dataLoaded) return;
  
try {
// Cargar configuraciones de usuarios (secrets de Google Authenticator)
// NOTA: Se usa 'shared: true' para que todos los dispositivos vean los mismos datos
const usersData = await window.storage.get('comcesa_users', true);
if(usersData) {
const savedUsers = JSON.parse(usersData.value);
savedUsers.forEach(saved => {
const user = users.find(u => u.id === saved.id);
if(user) user.secret = saved.secret;
});
console.log('‚úÖ Configuraciones de usuarios cargadas');
}

// Cargar registros de asistencia (COMPARTIDOS entre todos los dispositivos)
const recordsData = await window.storage.get('comcesa_records', true);
if(recordsData) {
records = JSON.parse(recordsData.value);
console.log(`‚úÖ ${records.length} registros cargados desde la nube`);
}
} catch(error) {
console.log('‚ÑπÔ∏è Primera vez usando el sistema - iniciando desde cero');
}
  
dataLoaded = true;
}

async function saveUsers() {
try {
const usersToSave = users.filter(u => u.secret).map(u => ({
id: u.id,
secret: u.secret
}));
await window.storage.set('comcesa_users', JSON.stringify(usersToSave), true);
console.log('‚úÖ Configuraciones guardadas en la nube');
} catch(error) {
console.error('Error al guardar usuarios:', error);
alert('‚ö†Ô∏è Error al guardar configuraci√≥n. Por favor intenta de nuevo.');
}
}

async function saveRecords() {
try {
await window.storage.set('comcesa_records', JSON.stringify(records), true);
console.log('‚úÖ Registros guardados en la nube');
} catch(error) {
console.error('Error al guardar registros:', error);
alert('‚ö†Ô∏è Error al guardar registro. Por favor intenta de nuevo.');
}
}

// Cargar datos al iniciar
window.addEventListener('load', loadData);

// ================= FUNCIONES TOTP (Google Authenticator) =================
function generateSecret() {
const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
let secret = '';
for(let i = 0; i < 32; i++) {
secret += chars.charAt(Math.floor(Math.random() * chars.length));
}
return secret;
}

function base32Decode(secret) {
const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
let bits = '';
for(let i = 0; i < secret.length; i++) {
const val = alphabet.indexOf(secret.charAt(i).toUpperCase());
if(val === -1) continue;
bits += val.toString(2).padStart(5, '0');
}
const bytes = [];
for(let i = 0; i + 8 <= bits.length; i += 8) {
bytes.push(parseInt(bits.substr(i, 8), 2));
}
return new Uint8Array(bytes);
}

function generateTOTP(secret) {
const key = base32Decode(secret);
const epoch = Math.floor(Date.now() / 1000);
const time = Math.floor(epoch / 30);
const timeHex = time.toString(16).padStart(16, '0');
const timeBytes = new Uint8Array(8);
for(let i = 0; i < 8; i++) {
timeBytes[i] = parseInt(timeHex.substr(i * 2, 2), 16);
}
const shaObj = new jsSHA("SHA-1", "UINT8ARRAY");
shaObj.setHMACKey(key, "UINT8ARRAY");
shaObj.update(timeBytes);
const hmac = shaObj.getHMAC("UINT8ARRAY");
const offset = hmac[hmac.length - 1] & 0xf;
const binary = ((hmac[offset] & 0x7f) << 24) |
((hmac[offset + 1] & 0xff) << 16) |
((hmac[offset + 2] & 0xff) << 8) |
(hmac[offset + 3] & 0xff);
const otp = (binary % 1000000).toString().padStart(6, '0');
return otp;
}

// ================= VERIFICAR USUARIO =================
function checkUser() {
const user = users.find(u => u.username === username.value);
if(!user) return alert("‚ùå Usuario no encontrado");
currentUser = user;

// Si no tiene secret configurado, mostrar setup
if(!user.secret) {
showSetupScreen();
} else {
userName.textContent = user.name;
showScreen("verificationScreen");
}
}

// ================= PANTALLA DE CONFIGURACI√ìN =================
function showSetupScreen() {
setupUserName.textContent = currentUser.name;
  
// Generar nuevo secret
const secret = generateSecret();
currentUser.tempSecret = secret;
  
// Mostrar secret
secretKey.textContent = secret;
  
// Generar QR code
document.getElementById('qrcode').innerHTML = '';
const qrText = `otpauth://totp/COMCESA:${currentUser.username}?secret=${secret}&issuer=COMCESA`;
new QRCode(document.getElementById("qrcode"), {
text: qrText,
width: 200,
height: 200
});
  
showScreen("setupScreen");
}

function completeSetup() {
const inputCode = setupCodeInput.value;
const validCode = generateTOTP(currentUser.tempSecret);
  
if(inputCode === validCode) {
currentUser.secret = currentUser.tempSecret;
delete currentUser.tempSecret;
saveUsers(); // Guardar configuraci√≥n
alert("‚úÖ Configuraci√≥n completada exitosamente");
currentUser.role === "admin" ? showAdminScreen() : showEmployeeScreen();
} else {
alert("‚ùå C√≥digo incorrecto. Verifica que sea el c√≥digo actual de tu app.");
}
}

// ================= VERIFICAR C√ìDIGO =================
function verifyCode() {
const inputCode = codeInput.value;
const validCode = generateTOTP(currentUser.secret);
  
if(inputCode === validCode) {
currentUser.role === "admin" ? showAdminScreen() : showEmployeeScreen();
} else {
alert("‚ùå C√≥digo incorrecto");
}
}

// ================= VALIDACIONES =================
function recordAttendance(type) {
const today = new Date().toLocaleDateString('es-GT');
const todayRecords = records.filter(r => r.userId === currentUser.id && r.timestamp.startsWith(today));
const last = todayRecords.slice(-1)[0];
if(type === "salida" && !last) return alert("‚ùå No puedes marcar salida sin entrada");
if(last && last.type === type) return alert("‚ö†Ô∏è Ya marcaste " + type + " hoy");
records.push({
id: records.length + 1,
userId: currentUser.id,
name: currentUser.name,
type,
timestamp: new Date().toLocaleString('es-GT')
});
saveRecords(); // Guardar en almacenamiento permanente
alert("‚úÖ " + type.toUpperCase() + " registrada");
showEmployeeScreen();
}

// ================= PANTALLAS =================
function showEmployeeScreen() {
employeeName.textContent = currentUser.name;
const today = new Date().toLocaleDateString('es-GT');
employeeRecords.innerHTML = records
.filter(r => r.userId === currentUser.id && r.timestamp.startsWith(today))
.reverse()
.map(r => `
<div class="card">
<strong>${r.type.toUpperCase()}</strong>
<span class="badge ${r.type === 'entrada' ? 'badge-entrada' : 'badge-salida'}">${r.type}</span>
<div>${r.timestamp}</div>
</div>`).join("") || "<p>No hay registros hoy</p>";
showScreen("employeeScreen");
}

function showAdminScreen() {
totalEmployees.textContent = users.filter(u => u.role === 'empleado').length;
totalRecords.textContent = records.length;
currentDate.textContent = new Date().toLocaleDateString('es-GT');

// Cargar empleados en el filtro
filterUser.innerHTML = `<option value="">Todos los empleados</option>` +
users
.filter(u => u.role === 'empleado')
.map(u => `<option value="${u.id}">${u.name}</option>`)
.join("");

// Limpiar filtros y mostrar todo
filterDate.value = '';
renderAdminRecords();
showScreen("adminScreen");
}

// ================= FILTROS DE HISTORIAL =================
function renderAdminRecords() {
const userId = filterUser.value;
const date = filterDate.value;

let filtered = [...records];

// Filtrar por empleado
if(userId) {
filtered = filtered.filter(r => r.userId == userId);
}

// Filtrar por fecha
if(date) {
const selectedDate = new Date(date + 'T00:00:00');
const dateStr = selectedDate.toLocaleDateString('es-GT');
filtered = filtered.filter(r => r.timestamp.startsWith(dateStr));
}

// Actualizar contador
const filterText = userId || date ? ` (${filtered.length} de ${records.length})` : ` (${filtered.length} total)`;
recordCount.textContent = filterText;

// Renderizar tabla
recordsBody.innerHTML = filtered
.slice()
.reverse()
.map(r => `
<tr>
<td>${r.id}</td>
<td>${r.name}</td>
<td><span class="badge ${r.type === 'entrada' ? 'badge-entrada' : 'badge-salida'}">${r.type.toUpperCase()}</span></td>
<td>${r.timestamp}</td>
</tr>
`).join("") || `<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:40px">Sin registros para mostrar</td></tr>`;
}

function filterToday() {
const today = new Date();
filterDate.value = today.toISOString().split('T')[0];
renderAdminRecords();
}

function filterYesterday() {
const yesterday = new Date();
yesterday.setDate(yesterday.getDate() - 1);
filterDate.value = yesterday.toISOString().split('T')[0];
renderAdminRecords();
}

function clearFilters() {
filterUser.value = '';
filterDate.value = '';
renderAdminRecords();
}

function showScreen(id) {
document.querySelectorAll(".container").forEach(c => c.classList.add("hidden"));
document.getElementById(id).classList.remove("hidden");
}

function logout() {
currentUser = null;
username.value = codeInput.value = setupCodeInput.value = "";
showScreen("loginScreen");
}

function exportCSV() {
// Obtener los registros filtrados actuales
const userId = filterUser?.value;
const date = filterDate?.value;
let filtered = [...records];

if(userId) {
filtered = filtered.filter(r => r.userId == userId);
}
if(date) {
const selectedDate = new Date(date + 'T00:00:00');
const dateStr = selectedDate.toLocaleDateString('es-GT');
filtered = filtered.filter(r => r.timestamp.startsWith(dateStr));
}

// Generar CSV
let csv = 'ID,Nombre,Tipo,Fecha y Hora\n';
filtered.forEach(r => {
csv += `${r.id},${r.name},${r.type},${r.timestamp}\n`;
});

// Descargar
const blob = new Blob([csv], {type: 'text/csv'});
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
const fileName = userId || date ? 
`asistencias_filtradas_${new Date().toISOString().split('T')[0]}.csv` :
`asistencias_completas_${new Date().toISOString().split('T')[0]}.csv`;
a.download = fileName;
a.click();

alert(`‚úÖ ${filtered.length} registros exportados a CSV`);
}

async function clearAllData() {
if(!confirm('‚ö†Ô∏è ¬øEst√°s seguro de borrar TODOS los datos?\n\n- Todos los registros de asistencia\n- Todas las configuraciones de Google Authenticator\n\nEsta acci√≥n NO se puede deshacer.')) {
return;
}
  
if(!confirm('üî¥ √öLTIMA CONFIRMACI√ìN\n\n¬øRealmente quieres BORRAR TODO?')) {
return;
}
  
try {
await window.storage.delete('comcesa_users', true);
await window.storage.delete('comcesa_records', true);
records = [];
users.forEach(u => u.secret = null);
alert('‚úÖ Todos los datos han sido borrados de la nube');
logout();
} catch(error) {
alert('Error al borrar datos: ' + error.message);
}
}
</script>
</body>

</html>

