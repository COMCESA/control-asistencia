<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>COMCESA - Control de Asistencia</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/3.2.0/sha.js"></script>
<style>
:root {
--primary:#0B2A4A;--secondary:#1F4E79;--success:#2E7D32;
--danger:#C62828;--bg:#F4F6F8;--card:#fff;
--text:#1F2937;--muted:#6B7280;--border:#E5E7EB;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:"Segoe UI",Arial;background:var(--bg);padding:30px}
.container{max-width:480px;margin:40px auto;background:var(--card);
border-radius:6px;border:1px solid var(--border);padding:35px}
.container-wide{max-width:1200px}
.logo{text-align:center;margin-bottom:25px}
.logo img{height:55px}
h1{font-size:24px;color:var(--primary);text-align:center}
.subtitle{text-align:center;color:var(--muted);margin-bottom:25px;font-size:14px}
.input-group{margin-bottom:18px}
label{font-size:13px;font-weight:600;margin-bottom:6px;display:block}
input,select{width:100%;padding:11px;border:1px solid var(--border);border-radius:4px}
.btn{width:100%;padding:12px;font-weight:600;border:none;border-radius:4px;cursor:pointer;transition:opacity 0.2s}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn-primary{background:var(--primary);color:#fff}
.btn-secondary{background:#E5E7EB;margin-top:10px}
.btn-success{background:var(--success);color:#fff}
.btn-danger{background:var(--danger);color:#fff}
.btn-small{width:auto;padding:8px 16px}
.hidden{display:none}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:15px}
.card{background:#F9FAFB;border:1px solid var(--border);padding:15px;border-radius:4px;margin-bottom:10px}
.badge{padding:4px 10px;font-size:11px;border-radius:20px;color:#fff}
.badge-entrada{background:var(--success)}
.badge-salida{background:var(--danger)}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:15px}
.stat-card{background:#fff;border:1px solid var(--border);padding:20px;border-radius:6px;text-align:center}
.stat-number{font-size:28px;font-weight:bold;color:var(--primary)}
table{width:100%;border-collapse:collapse}
th{background:var(--primary);color:#fff;padding:12px}
td{padding:12px;border-bottom:1px solid var(--border)}
.alert{padding:12px;border-radius:4px;margin-bottom:15px;font-size:14px}
.alert-info{background:#DBEAFE;color:#1E40AF;border:1px solid #93C5FD}
.alert-warning{background:#FEF3C7;color:#92400E;border:1px solid #FCD34D}
.alert-danger{background:#FEE2E2;color:#991B1B;border:1px solid #FCA5A5}
.qr-container{text-align:center;padding:20px;background:#fff;border:2px dashed var(--border);border-radius:8px;margin:20px 0}
#qrcode{display:inline-block;padding:15px;background:#fff}
.secret-key{background:#F3F4F6;padding:10px;border-radius:4px;font-family:monospace;font-size:14px;text-align:center;margin:10px 0;word-break:break-all}
.setup-steps{background:#F9FAFB;padding:15px;border-radius:4px;margin:15px 0}
.setup-steps ol{margin-left:20px}
.setup-steps li{margin:8px 0;font-size:14px}
.loading{text-align:center;padding:20px;color:var(--muted)}
.spinner{border:3px solid var(--border);border-top:3px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
@media(max-width:768px){.grid-2,.stats{grid-template-columns:1fr}}
</style>
</head>
<body>
<!-- LOADING INICIAL -->
<div id="loadingScreen" class="container">
<div class="spinner"></div>
<p class="loading">Cargando datos del sistema...</p>
</div>

<!-- LOGIN -->
<div id="loginScreen" class="container hidden">
<div class="logo">
<img src="https://tse4.mm.bing.net/th/id/OIP.FWDv-1kVSpV5Dz_OMAu4IgHaBo?rs=1">
</div>
<h1>Control de Asistencia</h1>
<p class="subtitle">Ingresa tu usuario</p>
<div class="input-group">
<label>Usuario</label>
<input id="username" autocomplete="username">
</div>
<button class="btn btn-primary" onclick="checkUser()">Continuar</button>
</div>

<!-- CONFIGURACI√ìN INICIAL -->
<div id="setupScreen" class="container hidden">
<h1>Configuraci√≥n Inicial</h1>
<p class="subtitle">Hola, <span id="setupUserName"></span></p>
<div class="alert alert-warning">
‚ö†Ô∏è Es tu primera vez. Configura Google Authenticator
</div>
<div class="setup-steps">
<strong>Sigue estos pasos:</strong>
<ol>
<li>Descarga <strong>Google Authenticator</strong> en tu celular (Play Store o App Store)</li>
<li>Abre la app y toca el bot√≥n <strong>+</strong></li>
<li>Selecciona <strong>"Escanear c√≥digo QR"</strong></li>
<li>Escanea el c√≥digo QR de abajo</li>
</ol>
</div>
<div class="qr-container">
<div id="qrcode"></div>
<p style="margin-top:10px;color:var(--muted);font-size:13px">
O ingresa manualmente esta clave:
</p>
<div class="secret-key" id="secretKey"></div>
</div>
<div class="input-group">
<label>Ingresa el c√≥digo de 6 d√≠gitos que aparece en tu app</label>
<input id="setupCodeInput" placeholder="000000" maxlength="6" type="tel" oninput="validateSetupCode()">
</div>
<button id="setupVerifyBtn" class="btn btn-primary" onclick="completeSetup()" disabled>Verificar y Continuar</button>
<button class="btn btn-secondary" onclick="logout()">Cancelar</button>
</div>

<!-- VERIFICACI√ìN -->
<div id="verificationScreen" class="container hidden">
<h1>Verificaci√≥n</h1>
<p class="subtitle">Hola, <span id="userName"></span></p>
<div class="alert alert-info">
üì± Abre <strong>Google Authenticator</strong> en tu celular
</div>
<div class="input-group">
<label>Ingresa el c√≥digo de 6 d√≠gitos de tu app</label>
<input id="codeInput" placeholder="000000" maxlength="6" type="tel" oninput="validateVerifyCode()">
</div>
<button id="verifyBtn" class="btn btn-primary" onclick="verifyCode()" disabled>Verificar</button>
<button class="btn btn-secondary" onclick="logout()">Cancelar</button>
<div style="margin-top:15px;text-align:center;color:var(--muted);font-size:12px">
El c√≥digo cambia cada 30 segundos
</div>
</div>

<!-- EMPLEADO -->
<div id="employeeScreen" class="container hidden">
<h1>Bienvenido, <span id="employeeName"></span></h1>
<div class="grid-2">
<button class="btn btn-success" onclick="recordAttendance('entrada')">Registrar Entrada</button>
<button class="btn btn-danger" onclick="recordAttendance('salida')">Registrar Salida</button>
</div>
<h3 style="margin:20px 0">Mis registros de hoy</h3>
<div id="employeeRecords"></div>
<button class="btn btn-secondary" onclick="logout()">Cerrar sesi√≥n</button>
</div>

<!-- ADMIN -->
<div id="adminScreen" class="container container-wide hidden">
<h1>Panel Administrador</h1>
<div class="stats">
<div class="stat-card"><div class="stat-number" id="totalEmployees">0</div>Total Empleados</div>
<div class="stat-card"><div class="stat-number" id="totalRecords">0</div>Registros</div>
<div class="stat-card"><div class="stat-number" id="currentDate"></div>Fecha</div>
</div>

<div class="card" style="margin:20px 0">
<h3 style="margin-bottom:15px;color:var(--primary)">üîç Filtrar Historial</h3>
<div class="grid-2">
<div class="input-group" style="margin:0">
<label>Empleado</label>
<select id="filterUser" onchange="renderAdminRecords()">
<option value="">Todos los empleados</option>
</select>
</div>
<div class="input-group" style="margin:0">
<label>Fecha</label>
<input type="date" id="filterDate" onchange="renderAdminRecords()">
</div>
</div>
<div style="margin-top:15px;display:flex;gap:10px">
<button class="btn btn-secondary" onclick="filterToday()" style="width:auto;padding:8px 16px">üìÖ Hoy</button>
<button class="btn btn-secondary" onclick="filterYesterday()" style="width:auto;padding:8px 16px">‚èÆÔ∏è Ayer</button>
<button class="btn btn-secondary" onclick="clearFilters()" style="width:auto;padding:8px 16px">üîÑ Limpiar Filtros</button>
</div>
</div>

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h2 style="color:var(--primary)">Historial de Asistencias <span id="recordCount" style="font-size:16px;color:var(--muted)"></span></h2>
<div>
<button class="btn btn-primary" onclick="exportCSV()" style="margin:0;width:auto;padding:8px 16px">üì• Exportar CSV</button>
</div>
</div>

<table>
<thead><tr><th>ID</th><th>Nombre</th><th>Tipo</th><th>Fecha y Hora</th></tr></thead>
<tbody id="recordsBody"></tbody>
</table>
<button class="btn btn-secondary" onclick="logout()" style="margin-top:20px">Cerrar sesi√≥n</button>
</div>

<script>
// ================= CONFIGURACI√ìN GOOGLE SHEETS =================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxEHbHkZ5ncT0PU5F2sBYSaLzd_ebZUaWlEySBnww7TaYxIMVtBdWuNKOE0tX9wWlRK/exec';

// ================= USUARIOS =================
const users = [
{ id:1, username:'josue.rodriguez', name:'Josue Rodriguez', role:'empleado', secret:null },
{ id:2, username:'yanira.lopez', name:'Yanira Lopez', role:'empleado', secret:null },
{ id:3, username:'luz.deleon', name:'Luz De Leon', role:'empleado', secret:null },
{ id:4, username:'rosa.gomez', name:'Rosa Gomez', role:'empleado', secret:null },
{ id:5, username:'benjamin.perez', name:'Benjamin Perez', role:'empleado', secret:null },
{ id:6, username:'dulce.guzman', name:'Dulce Guzman', role:'empleado', secret:null },
{ id:7, username:'roniel.chacon', name:'Roniel Chacon', role:'empleado', secret:null },
{ id:8, username:'william.palacios', name:'William Palacios', role:'empleado', secret:null },
{ id:9, username:'maria.rosales', name:'Maria Rosales', role:'empleado', secret:null },
{ id:10, username:'erick.garcia', name:'Erick Garcia', role:'empleado', secret:null },
{ id:11, username:'hever.rian', name:'Hever Rian', role:'empleado', secret:null },
{ id:12, username:'gabriela.vasquez', name:'Gabriela Vasquez', role:'empleado', secret:null },
{ id:13, username:'jorge.mendez', name:'Jorge Mendez', role:'empleado', secret:null },
{ id:14, username:'elias.ixcoy', name:'Elias Ixcoy', role:'empleado', secret:null },
{ id:15, username:'william.camey', name:'William Camey', role:'empleado', secret:null },
{ id:16, username:'rodolfo.xuya', name:'Rodolfo Xuya', role:'empleado', secret:null },
{ id:17, username:'bethzabe.delaroca', name:'Bethzabe de la Roca', role:'empleado', secret:null },
{ id:18, username:'teresa.aifan', name:'Teresa de Jesus Aifan', role:'empleado', secret:null },
{ id:19, username:'benigno.deleon', name:'Benigno De Leon Vasquez', role:'empleado', secret:null },
{ id:20, username:'juan.rodriguez', name:'Juan Jose Rodriguez', role:'empleado', secret:null },
{ id:21, username:'jose.avila', name:'Jose Avila', role:'empleado', secret:null },
{ id:22, username:'christian.valencia', name:'Christian Valencia', role:'empleado', secret:null },
{ id:23, username:'sergio.garcia', name:'Sergio Garcia', role:'empleado', secret:null },
{ id:99, username:'sys.ctrl_9XQ', name:'Administrador del Sistema', role:'admin', secret:null }
];

let records = [];
let currentUser = null;
let dataLoaded = false;

// ================= UTILIDADES DE FECHA (ISO) =================
function getISODate() {
  return new Date().toISOString();
}

function formatDateForDisplay(isoString) {
  const date = new Date(isoString);
  return date.toLocaleString('es-GT', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
}

function getDateOnly(isoString) {
  return isoString.split('T')[0];
}

function getTodayDateOnly() {
  return new Date().toISOString().split('T')[0];
}

// ================= CARGAR DATOS DESDE GOOGLE SHEETS =================
async function loadData() {
  if(dataLoaded) return;
  
  try {
    // Cargar usuarios con secrets desde Google Sheets
    const usersResponse = await fetch(SCRIPT_URL + '?action=getUsers');
    if(!usersResponse.ok) throw new Error('Error al cargar usuarios');
    
    const savedUsers = await usersResponse.json();
    
    savedUsers.forEach(saved => {
      const user = users.find(u => u.id === saved.id);
      if(user && saved.secret) user.secret = saved.secret;
    });
    
    // Cargar registros
    const recordsResponse = await fetch(SCRIPT_URL + '?action=getRecords');
    if(!recordsResponse.ok) throw new Error('Error al cargar registros');
    
    records = await recordsResponse.json();
    
    console.log('‚úÖ Datos cargados desde Google Sheets');
  } catch(error) {
    console.error('‚ö†Ô∏è Error al cargar datos:', error);
  }
  
  dataLoaded = true;
}

async function saveUser(userId, secret) {
  try {
    const user = users.find(u => u.id === userId);
    const formData = new FormData();
    formData.append('action', 'saveUser');
    formData.append('data', JSON.stringify({
      id: userId,
      username: user.username,
      secret: secret
    }));
    
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });
    
    if(!response.ok) throw new Error('Error en la respuesta del servidor');
    
    console.log('‚úÖ Usuario guardado en Google Sheets');
    return true;
  } catch(error) {
    console.error('‚ùå Error al guardar usuario:', error);
    return false;
  }
}

async function saveRecord(record) {
  try {
    const formData = new FormData();
    formData.append('action', 'saveRecord');
    formData.append('data', JSON.stringify(record));
    
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });
    
    if(!response.ok) throw new Error('Error en la respuesta del servidor');
    
    console.log('‚úÖ Registro guardado en Google Sheets');
    return true;
  } catch(error) {
    console.error('‚ùå Error al guardar registro:', error);
    return false;
  }
}

// ================= INICIALIZACI√ìN =================
window.addEventListener('load', async () => {
  await loadData();
  document.getElementById("loadingScreen").classList.add("hidden");
  showScreen("loginScreen");
});

// ================= FUNCIONES TOTP =================
function generateSecret() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
  let secret = '';
  for(let i = 0; i < 32; i++) {
    secret += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return secret;
}

function base32Decode(secret) {
  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
  let bits = '';
  for(let i = 0; i < secret.length; i++) {
    const val = alphabet.indexOf(secret.charAt(i).toUpperCase());
    if(val === -1) continue;
    bits += val.toString(2).padStart(5, '0');
  }
  const bytes = [];
  for(let i = 0; i + 8 <= bits.length; i += 8) {
    bytes.push(parseInt(bits.substr(i, 8), 2));
  }
  return new Uint8Array(bytes);
}

function generateTOTP(secret) {
  return generateTOTPAt(secret, Date.now());
}

function generateTOTPAt(secret, timestamp) {
  const key = base32Decode(secret);
  const epoch = Math.floor(timestamp / 1000);
  const time = Math.floor(epoch / 30);
  const timeHex = time.toString(16).padStart(16, '0');
  const timeBytes = new Uint8Array(8);
  for(let i = 0; i < 8; i++) {
    timeBytes[i] = parseInt(timeHex.substr(i * 2, 2), 16);
  }
  const shaObj = new jsSHA("SHA-1", "UINT8ARRAY");
  shaObj.setHMACKey(key, "UINT8ARRAY");
  shaObj.update(timeBytes);
  const hmac = shaObj.getHMAC("UINT8ARRAY");
  const offset = hmac[hmac.length - 1] & 0xf;
  const binary = ((hmac[offset] & 0x7f) << 24) |
                 ((hmac[offset + 1] & 0xff) << 16) |
                 ((hmac[offset + 2] & 0xff) << 8) |
                 (hmac[offset + 3] & 0xff);
  const otp = (binary % 1000000).toString().padStart(6, '0');
  return otp;
}

function verifyTOTPWithTolerance(secret, inputCode) {
  const now = Date.now();
  // Validar ventana actual y ¬±30 segundos (¬±1 per√≠odo)
  for (let i = -1; i <= 1; i++) {
    if (generateTOTPAt(secret, now + i * 30000) === inputCode) {
      return true;
    }
  }
  return false;
}

// ================= VALIDACI√ìN DE INPUTS =================
function validateSetupCode() {
  const code = setupCodeInput.value;
  setupVerifyBtn.disabled = code.length !== 6;
}

function validateVerifyCode() {
  const code = codeInput.value;
  verifyBtn.disabled = code.length !== 6;
}

// ================= VERIFICAR USUARIO =================
function checkUser() {
  const user = users.find(u => u.username === username.value.toLowerCase().trim());
  if(!user) return alert("‚ùå Usuario no encontrado");
  currentUser = user;

  if(!user.secret) {
    showSetupScreen();
  } else {
    userName.textContent = user.name;
    showScreen("verificationScreen");
  }
}

// ================= CONFIGURACI√ìN =================
function showSetupScreen() {
  setupUserName.textContent = currentUser.name;
  const secret = generateSecret();
  currentUser.tempSecret = secret;
  secretKey.textContent = secret;
  
  document.getElementById('qrcode').innerHTML = '';
  const qrText = `otpauth://totp/COMCESA:${currentUser.username}?secret=${secret}&issuer=COMCESA`;
  new QRCode(document.getElementById("qrcode"), {
    text: qrText,
    width: 200,
    height: 200
  });
  
  setupCodeInput.value = '';
  setupVerifyBtn.disabled = true;
  showScreen("setupScreen");
}

async function completeSetup() {
  const inputCode = setupCodeInput.value;
  
  if(verifyTOTPWithTolerance(currentUser.tempSecret, inputCode)) {
    currentUser.secret = currentUser.tempSecret;
    delete currentUser.tempSecret;
    
    const saved = await saveUser(currentUser.id, currentUser.secret);
    if(!saved) {
      alert("‚ö†Ô∏è Configuraci√≥n guardada localmente. Revisa la conexi√≥n con el servidor.");
    }
    
    alert("‚úÖ Configuraci√≥n completada exitosamente");
    currentUser.role === "admin" ? showAdminScreen() : showEmployeeScreen();
  } else {
    alert("‚ùå C√≥digo incorrecto. Verifica que sea el c√≥digo actual de tu app.");
  }
}

// ================= VERIFICAR C√ìDIGO =================
function verifyCode() {
  const inputCode = codeInput.value;
  
  if(verifyTOTPWithTolerance(currentUser.secret, inputCode)) {
    currentUser.role === "admin" ? showAdminScreen() : showEmployeeScreen();
  } else {
    alert("‚ùå C√≥digo incorrecto");
  }
}

// ================= REGISTRAR ASISTENCIA =================
async function recordAttendance(type) {
  // Deshabilitar todos los botones para evitar doble click
  const buttons = document.querySelectorAll("button");
  buttons.forEach(b => b.disabled = true);
  
  try {
    const today = getTodayDateOnly();
    const todayRecords = records.filter(r => r.userId === currentUser.id && getDateOnly(r.timestamp) === today);
    
    // Validaci√≥n: no puede marcar salida sin entrada
    if(type === "salida" && todayRecords.length === 0) {
      alert("‚ùå No puedes marcar salida sin haber marcado entrada");
      return;
    }
    
    // Validaci√≥n: no marcar el mismo tipo consecutivamente
    const last = todayRecords.slice(-1)[0];
    if(last && last.type === type) {
      alert(`‚ö†Ô∏è Ya marcaste ${type} como √∫ltimo registro. Debes marcar ${type === 'entrada' ? 'salida' : 'entrada'} primero.`);
      return;
    }
    
    // ID √∫nico con timestamp + aleatoriedad
    const newRecord = {
      id: Date.now() + Math.floor(Math.random() * 1000),
      userId: currentUser.id,
      name: currentUser.name,
      type: type,
      timestamp: getISODate()
    };
    
    records.push(newRecord);
    
    const saved = await saveRecord(newRecord);
    if(!saved) {
      alert(`‚ö†Ô∏è ${type.toUpperCase()} registrada localmente. Revisa la conexi√≥n con el servidor.`);
    } else {
      alert(`‚úÖ ${type.toUpperCase()} registrada correctamente`);
    }
    
    showEmployeeScreen();
  } finally {
    // Re-habilitar botones
    buttons.forEach(b => b.disabled = false);
  }
}

// ================= PANTALLAS =================
function showEmployeeScreen() {
  employeeName.textContent = currentUser.name;
  const today = getTodayDateOnly();
  const todayRecords = records.filter(r => r.userId === currentUser.id && getDateOnly(r.timestamp) === today);
  
  employeeRecords.innerHTML = todayRecords
    .slice()
    .reverse()
    .map(r => `
      <div class="card">
        <strong>${r.type.toUpperCase()}</strong>
        <span class="badge ${r.type === 'entrada' ? 'badge-entrada' : 'badge-salida'}">${r.type}</span>
        <div>${formatDateForDisplay(r.timestamp)}</div>
      </div>`).join("") || "<p style='text-align:center;color:var(--muted);padding:20px'>No hay registros hoy</p>";
  
  showScreen("employeeScreen");
}

function showAdminScreen() {
  totalEmployees.textContent = users.filter(u => u.role === 'empleado').length;
  totalRecords.textContent = records.length;
  
  const today = new Date();
  currentDate.textContent = today.toLocaleDateString('es-GT', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });

  filterUser.innerHTML = `<option value="">Todos los empleados</option>` +
    users.filter(u => u.role === 'empleado')
      .map(u => `<option value="${u.id}">${u.name}</option>`).join("");

  filterDate.value = '';
  renderAdminRecords();
  showScreen("adminScreen");
}

// ================= FILTROS =================
function renderAdminRecords() {
  const userId = filterUser.value;
  const date = filterDate.value;
  let filtered = [...records];

  if(userId) filtered = filtered.filter(r => r.userId == userId);
  if(date) {
    filtered = filtered.filter(r => getDateOnly(r.timestamp) === date);
  }

  const filterText = userId || date ? ` (${filtered.length} de ${records.length})` : ` (${filtered.length} total)`;
  recordCount.textContent = filterText;

  recordsBody.innerHTML = filtered.slice().reverse()
    .map(r => `
      <tr>
        <td>${r.id}</td>
        <td>${r.name}</td>
        <td><span class="badge ${r.type === 'entrada' ? 'badge-entrada' : 'badge-salida'}">${r.type.toUpperCase()}</span></td>
        <td>${formatDateForDisplay(r.timestamp)}</td>
      </tr>
    `).join("") || `<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:40px">Sin registros para mostrar</td></tr>`;
}

function filterToday() {
  filterDate.value = getTodayDateOnly();
  renderAdminRecords();
}

function filterYesterday() {
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  filterDate.value = yesterday.toISOString().split('T')[0];
  renderAdminRecords();
}

function clearFilters() {
  filterUser.value = '';
  filterDate.value = '';
  renderAdminRecords();
}

function showScreen(id) {
  document.querySelectorAll(".container").forEach(c => c.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function logout() {
  currentUser = null;
  username.value = codeInput.value = setupCodeInput.value = "";
  showScreen("loginScreen");
}

function exportCSV() {
  const userId = filterUser?.value;
  const date = filterDate?.value;
  let filtered = [...records];

  if(userId) filtered = filtered.filter(r => r.userId == userId);
  if(date) {
    filtered = filtered.filter(r => getDateOnly(r.timestamp) === date);
  }

  let csv = 'ID,Nombre,Tipo,Fecha y Hora\n';
  filtered.forEach(r => {
    csv += `${r.id},"${r.name}",${r.type},"${formatDateForDisplay(r.timestamp)}"\n`;
  });

  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const fileName = userId || date ? 
    `asistencias_filtradas_${getTodayDateOnly()}.csv` :
    `asistencias_completas_${getTodayDateOnly()}.csv`;
  a.download = fileName;
  a.click();
  window.URL.revokeObjectURL(url);

  alert(`‚úÖ ${filtered.length} registros exportados a CSV`);
}
</script>
</body>
</html>



